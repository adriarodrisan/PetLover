{
    "sourceFile": "Paginas_web/insertar_mascota.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1747233148991,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1747233148991,
            "name": "Commit-0",
            "content": "<?php\r\nini_set('display_errors', 1);\r\n\r\nini_set('display_startup_errors', 1);\r\n\r\nerror_reporting(E_ALL);\r\ntry {\r\n    $db = new PDO('mysql:host=localhost;dbname=protectora', 'petlove', 'mascota');\r\n    $db->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);\r\n}catch (PDOException $e){\r\n    echo 'FallÃ³ la conixion: ' . $e->getMessage(); \r\n}\r\n$chip= trim($_POST['Chip_ID']);\r\n$nombre= trim($_POST['Nombre']);\r\n$especie= trim($_POST['Especie']);\r\n$raza= trim($_POST['raza']);\r\n$fecha_nacimiento= trim($_POST['FechaNacimiento']);\r\n$sexo= trim($_POST['Sexo']);\r\n$peso= trim($_POST['Peso']);\r\n$estado= trim($_POST['Estado']);\r\n$imagen= $_FILES['Imagen']['name'];\r\nif(empty($chip)|| empty($nombre)|| empty($especie)|| empty($raza)|| empty($fecha_nacimiento)|| empty($sexo)|| empty($peso)|| empty($imagen)){\r\n    echo \"Por favor, no dejes ningun hueco vacio en el formulario\";\r\n    exit;\r\n}\r\n//verificar que no hay dos chips iguales\r\n$datos_animales = $db->prepare(\"SELECT COUNT(*) FROM Animal WHERE Chip_ID = :chip\");\r\n$datos_animales->bindParam(':chip', $chip);\r\n$datos_animales-> execute();\r\nif ($datos_animales->fetchColumn()>0){\r\n    echo \"Este animal ya esta registrado porfavor revise el numero de chip que puede estar equivocado.\";\r\n    exit;\r\n}\r\n$consulta_raza = $db->prepare(\"SELECT ID FROM Raza WHERE Nombre_Raza = :nombre\");\r\n$consulta_raza-> bindParam(':nombre',$raza);\r\n$consulta_raza-> execute();\r\n$id_raza= $consulta_raza->fetch(PDO::FETCH_ASSOC);\r\n$raza= $id_raza['ID'];\r\n$consulta_especie = $db->prepare(\"SELECT ID FROM Especie WHERE Nombre_Especie = :nombre\");\r\n$consulta_especie-> bindParam(':nombre',$especie);\r\n$consulta_especie-> execute();\r\n$id_especie= $consulta_especie->fetch(PDO::FETCH_ASSOC);\r\n$especie= $id_especie['ID'];\r\n$nombre_protectora = $_COOKIE['nombre'] ?? null;\r\n$datos_protectora= $db->prepare(\"SELECT ID FROM Refugio WHERE  Nombre= :nombre\");\r\n$datos_protectora-> bindParam(':nombre',$nombre_protectora);\r\n$datos_protectora-> execute();\r\n$id_protectora = $datos_protectora->fetch(PDO::FETCH_ASSOC);\r\n$protectora= $id_protectora['ID'];\r\n$rutaDestino = 'uploads/' . basename($_FILES['Imagen']['name']);\r\nmove_uploaded_file($_FILES['Imagen']['tmp_name'], $rutaDestino);\r\n$insert = $db->prepare(\"INSERT INTO Animal (Chip_ID, Nombre, Especie, raza, FechaNacimiento, Sexo, Peso, Estado, ID_refugio, Imagen) VALUES (:chip, :nombre, :especie, :raza, :fecha, :sexo, :peso, :estado, :refugio, :imagen)\");\r\n$insert->bindParam([\r\n    ':chip' => $chip,\r\n    ':nombre' => $nombre,\r\n    ':especie' => $especie,\r\n    ':raza' => $raza,\r\n    ':fecha' => $fecha_nacimiento,\r\n    ':sexo' => $sexo,\r\n    ':peso' => $peso,\r\n    ':estado' => $estado,\r\n    ':refugio' => $id_protectora,\r\n    ':imagen' => $rutaDestino\r\n]);\r\n    if($insert->execute()){\r\n    echo '<!DOCTYPE html>\r\n            <html lang=\"es\">\r\n                <head>\r\n                    <meta charset=\"UTF-8\">\r\n                    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n                    <title>Registro Del Animal Exitoso</title>\r\n                    \r\n                </head>\r\n                <body class=\"cuerpo\">\r\n                    <div class=\"alertas\">\r\n                        <h1>Registro Del Animal Exitoso</h1>\r\n                        <a href=\"Home_Petlover.php\"> Ir al inicio</a>\r\n                    </div>\r\n                </body>\r\n            </html>\r\n            ';\r\n            exit;\r\n}else{\r\n    echo \"Error al registrar usuario: \". db->errorInfo()[2];\r\n}\r\n?>"
        }
    ]
}